{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}Employee Dashboard{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

<style>
  :root {
    --sidebar-bg: #2f3e46;
    --sidebar-color: #ffffff;
    --sidebar-hover: #124e51;
    --active-bg: #52796f;
    --accent-btn: #3caea3;
    --accent-btn-hover: #2f8886;
    --topbar-bg: #ffffff;
    --topbar-border: #e0e0e0;
    --body-bg: #f8f9fa;
    --card-bg: #ffffff;
    --text-dark: #333333;
  }

  body {
    font-family: 'Inter', sans-serif;
    background-color: var(--body-bg);
    color: var(--text-dark);
    margin: 0;
    padding: 0;
  }

  .sidebar {
    width: 240px;
    position: fixed;
    top: 0;
    bottom: 0;
    left: 0;
    background-color: var(--sidebar-bg);
    color: var(--sidebar-color);
    padding-top: 20px;
    overflow-y: auto;
  }

  .sidebar .brand {
    font-size: 1.6rem;
    font-weight: 700;
    text-align: center;
    margin-bottom: 20px;
    color: var(--sidebar-color);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .sidebar a {
    display: block;
    padding: 12px 20px;
    color: var(--sidebar-color);
    text-decoration: none;
    font-weight: 500;
    transition: background-color 0.3s, padding-left 0.2s;
  }

  .sidebar a:hover {
    background-color: var(--sidebar-hover);
    padding-left: 25px;
  }

  .sidebar a.active {
    background-color: var(--active-bg);
    color: #fff;
    padding-left: 25px;
  }

  .topbar {
    position: fixed;
    top: 0;
    left: 240px;
    right: 0;
    height: 60px;
    background-color: var(--topbar-bg);
    border-bottom: 1px solid var(--topbar-border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 30px;
    z-index: 1000;
  }

  .topbar .welcome {
    font-size: 1.2rem;
    font-weight: 500;
    color: var(--text-dark);
  }

  .logout-btn {
    background-color: var(--accent-btn);
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    font-weight: 600;
    color: #fff !important;
    transition: background-color 0.2s;
  }

  .logout-btn:hover {
    background-color: var(--accent-btn-hover);
  }

  .content {
    margin-left: 240px;
    padding: 80px 30px 30px;
  }

  .profile-card {
    background-color: var(--card-bg);
    border-radius: 10px;
    padding: 25px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    margin-bottom: 30px;
  }

  .profile-header {
    text-align: center;
    margin-bottom: 25px;
  }

  .employee-photo {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: 50%;
    border: 3px solid var(--body-bg);
    margin-top: 10px;
  }

  .section-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 30px 0 15px;
    color: var(--text-dark);
    border-bottom: 3px solid var(--accent-btn);
    display: inline-block;
    padding-bottom: 5px;
  }

  .info-table th {
    width: 200px;
    background: var(--body-bg);
    font-weight: 500;
    text-align: left;
    padding: 10px 15px;
    vertical-align: top;
  }

  .info-table td {
    background: var(--card-bg);
    padding: 10px 15px;
  }

  .btn-edit {
    background-color: var(--accent-btn);
    color: #fff;
    padding: 6px 14px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.9rem;
    transition: background-color 0.2s;
  }

  .btn-edit:hover {
    background-color: var(--accent-btn-hover);
  }

  .btn-save {
    background-color: var(--accent-btn);
    color: #fff;
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    transition: background-color 0.2s;
  }

  .btn-save:hover {
    background-color: var(--accent-btn-hover);
  }

  .btn-cancel {
    background-color: #ddd;
    color: var(--text-dark);
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    margin-left: 10px;
    font-weight: 500;
  }

  @media (max-width: 768px) {
    .sidebar {
      width: 200px;
    }

    .content {
      margin-left: 200px;
      padding: 80px 15px 15px;
    }

    .topbar {
      left: 200px;
      padding: 0 15px;
    }
  }

  /* âœ… Sara Chatbot Styles - Fixed bottom-right */
  #sara-chatbot-widget {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 300px;
    background-color: #ffffff;
    border: 1px solid #ccc;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    font-size: 14px;
    z-index: 9999;
  }

  #sara-chatbot-header {
    background-color: #3caea3;
    color: #fff;
    padding: 12px 16px;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
  }

  #sara-chatbot-body {
    display: flex;
    flex-direction: column;
    padding: 10px;
    max-height: 300px;
    overflow-y: auto;
  }

  #sara-chatbot-messages {
    flex: 1;
    overflow-y: auto;
    margin-bottom: 10px;
  }

  #sara-chatbot-form {
    display: flex;
  }

  #sara-chatbot-input {
    flex: 1;
    border-radius: 6px 0 0 6px;
    border: 1px solid #ccc;
    padding: 6px 10px;
  }

  #sara-chatbot-form button {
    background: #3caea3;
    color: white;
    border: none;
    padding: 0 16px;
    border-radius: 0 6px 6px 0;
    cursor: pointer;
    transition: background 0.2s;
  }

  #sara-chatbot-form button:hover {
    background: #2f8886;
  }
</style>

</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="brand">SmartHR ERP</div>
    <a href="{% url 'employee_dashboard2' %}"
       class="{% if request.resolver_match.url_name == 'employee_dashboard' %}active{% endif %}">
      <i class="bi bi-speedometer2 me-2"></i> Dashboard
    </a>
    <a href="{% url 'employee_profile' %}"
       class="{% if request.resolver_match.url_name == 'employee_profile' %}active{% endif %}">
      <i class="bi bi-person-badge me-2"></i> Profile
    </a>
    <a href="{% url 'employee_calendar' %}"
       class="{% if request.resolver_match.url_name == 'employee_calendar' %}active{% endif %}">
      <i class="bi bi-calendar-check me-2"></i> Leaves
    </a>
    <a href="{% url 'employee_performance' %}"
       class="{% if request.resolver_match.url_name == 'employee_performance' %}active{% endif %}">
      <i class="bi bi-bar-chart-line me-2"></i> Performance
    </a>
    <a href="{% url 'employee_attendance_list' %}"
       class="{% if request.resolver_match.url_name == 'employee_attendance_list' %}active{% endif %}">
      <i class="bi bi-clock me-2"></i> Attendance
    </a>
    <a href="{% url 'employee_payslips' %}"
       class="{% if request.resolver_match.url_name == 'employee_payslips' %}active{% endif %}">
      <i class="bi bi-file-earmark-text me-2"></i> Payslips
    </a>
    <a href="{% url 'employee_job_list' %}"
       class="{% if request.resolver_match.url_name == 'employee_payslips' %}active{% endif %}">
      <i class="bi bi-file-earmark-text me-2"></i> job List
    </a>
    <a href="{% url 'employee_logout' %}"
       class="{% if request.resolver_match.url_name == 'employee_logout' %}active{% endif %}">
      <i class="bi bi-box-arrow-right me-2"></i> Logout
    </a>
  </div>

  <!-- Topbar -->
  <div class="topbar">
    <div class="welcome">Welcome, {{ request.COOKIES.employee_name }}</div>
    <a href="{% url 'employee_logout' %}" class="logout-btn">
      <i class="bi bi-box-arrow-right me-1"></i> Logout
    </a>
  </div>

  <!-- Page content -->
  <div class="content">
    {% block content %}
    <!-- Your normal content goes here, without any chatbot block -->
    {% endblock %}
  </div>

  <!-- Sara Chatbot Floating Widget -->
  <div id="sara-chatbot-widget" aria-label="HR Assistant Chatbot" role="region" aria-live="polite" aria-atomic="false">
    <div id="sara-chatbot-header" role="button" tabindex="0" aria-expanded="false" aria-controls="sara-chatbot-body">
      <span><i class="bi bi-robot"></i> Sara <span style="font-weight:400; font-size:0.9em;">(HR Assistant)</span></span>
      <button id="sara-chatbot-toggle" title="Close" aria-label="Close Chatbot">&times;</button>
    </div>
    <div id="sara-chatbot-body" aria-live="polite" aria-atomic="false">
      <div id="sara-chatbot-messages" aria-live="polite" aria-atomic="false"></div>
      <form id="sara-chatbot-form" autocomplete="off">
        <div class="input-group">
          <input type="text" class="form-control" id="sara-chatbot-input" placeholder="Ask Sara anything..." aria-label="Chat input">
          <button class="btn btn-gradient" type="submit" aria-label="Send message"><i class="bi bi-send"></i></button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const saraWidget = document.getElementById('sara-chatbot-widget');
    const saraHeader = document.getElementById('sara-chatbot-header');
    const saraBody = document.getElementById('sara-chatbot-body');
    const saraToggle = document.getElementById('sara-chatbot-toggle');
    const saraForm = document.getElementById('sara-chatbot-form');
    const saraInput = document.getElementById('sara-chatbot-input');
    const saraMessages = document.getElementById('sara-chatbot-messages');

    // Initially closed
    saraWidget.classList.remove('open');
    saraBody.style.display = 'none';
    saraHeader.setAttribute('aria-expanded', 'false');

    // Toggle open/close on header click or keyboard (Enter/Space)
    saraHeader.addEventListener('click', toggleChatbot);
    saraHeader.addEventListener('keydown', e => {
      if(e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        toggleChatbot();
      }
    });

    function toggleChatbot() {
      if (saraWidget.classList.contains('open')) {
        saraWidget.classList.remove('open');
        saraBody.style.display = 'none';
        saraHeader.setAttribute('aria-expanded', 'false');
      } else {
        saraWidget.classList.add('open');
        saraBody.style.display = 'flex';
        saraHeader.setAttribute('aria-expanded', 'true');
        setTimeout(() => saraInput.focus(), 200);
      }
    }

    // Close button click
    saraToggle.onclick = function(e) {
      e.stopPropagation();
      saraWidget.classList.remove('open');
      saraBody.style.display = 'none';
      saraHeader.setAttribute('aria-expanded', 'false');
    };

    // Handle form submit (send message)
    saraForm.onsubmit = function(e) {
      e.preventDefault();
      const msg = saraInput.value.trim();
      if (!msg) return;

      // Show user message
      saraMessages.innerHTML += `<div><b>You:</b> ${escapeHtml(msg)}</div>`;
      saraInput.value = '';
      saraMessages.scrollTop = saraMessages.scrollHeight;

      // Send message to backend
      fetch('/chatbot/api/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg })
      })
      .then(res => res.json())
      .then(data => {
        // Show bot response
        saraMessages.innerHTML += `<div><b>Sara:</b> ${escapeHtml(data.answer)}</div>`;
        saraMessages.scrollTop = saraMessages.scrollHeight;
      })
      .catch(() => {
        saraMessages.innerHTML += `<div><b>Sara:</b> Sorry, something went wrong.</div>`;
        saraMessages.scrollTop = saraMessages.scrollHeight;
      });
    };

    // Simple HTML escape function to prevent XSS
    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }
  </script>

</body>
</html>
