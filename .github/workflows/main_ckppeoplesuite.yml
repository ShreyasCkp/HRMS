name: Build and deploy Python app to Azure Web App - CKPPeopleSuite

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.10"
  AZ_WEBAPP_NAME: "CKPPeopleSuite"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      # ----------------------------
      # Install system deps for native Python packages (pycairo, etc.)
      # ----------------------------
      - name: Install system dependencies for native builds
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            pkg-config \
            python3-dev \
            libcairo2-dev \
            libgirepository1.0-dev \
            libglib2.0-dev \
            libpng-dev \
            libjpeg-dev \
            libffi-dev \
            git \
            curl

      - name: Set up Python version
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Create and Start virtual environment and Install dependencies
        run: |
          python -m venv antenv
          source antenv/bin/activate
          pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt

      - name: List project files (for review)
        run: |
          pwd
          echo "Top-level files and folders:"
          ls -la
          echo "smarthr_erp folder contents:"
          ls -la smarthr_erp || true
          echo "apps (masters, employee_management, ...):"
          ls -la | grep -E "masters|employee_management|leave_management|attendance_management|payroll_management|performance_management|recruitment|chatbot|notifications|reports" || true

      - name: Upload artifact for deployment jobs
        uses: actions/upload-artifact@v4
        with:
          name: python-app
          path: |
            .
            !antenv/

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: python-app

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_B73A844D7B4042E1A538960B63041480 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_0EA1EFF70B6249D5841F2861A29886E1 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_E84FA381A384446FBED047D7993DFEB4 }}

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        id: deploy-to-webapp
        with:
          app-name: ${{ env.AZ_WEBAPP_NAME }}
          slot-name: 'Production'

      # Ensure az CLI available (login step provides it, but make sure)
      - name: Show az version
        run: az --version

      # ----------------------------
      # Post-deploy: attempt SSH command (Linux App Service with SSH enabled)
      # ----------------------------
      - name: Run remote management commands via az webapp ssh (preferred for Linux)
        if: always()
        env:
          AZ_SUBSCRIPTION: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_E84FA381A384446FBED047D7993DFEB4 }}
          AZ_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
          AZ_WEBAPP_NAME: ${{ env.AZ_WEBAPP_NAME }}
        run: |
          echo "Trying az webapp ssh to run collectstatic & migrate..."
          set -e
          az webapp ssh --subscription "$AZ_SUBSCRIPTION" --resource-group "$AZ_RESOURCE_GROUP" --name "$AZ_WEBAPP_NAME" --command "python manage.py collectstatic --noinput && python manage.py migrate --noinput" && exit 0
          echo "az webapp ssh failed or SSH not enabled. Will attempt Kudu fallback."

      # ----------------------------
      # KUDU fallback: use Kudu API to run commands (works for Windows & Linux App Service)
      # Requires: AZURE_WEBAPP_PUBLISH_PROFILE (add this as a secret containing the publish profile XML)
      # ----------------------------
      - name: Kudu fallback - run collectstatic & migrate using Kudu API
        if: always()
        env:
          AZ_WEBAPP_NAME: ${{ env.AZ_WEBAPP_NAME }}
          KUDU_PUBLISH_PROFILE: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}  # must be set in repo secrets
        run: |
          if [ -z "$KUDU_PUBLISH_PROFILE" ]; then
            echo "No KUDU publish profile secret found. Skipping Kudu commands."
            exit 0
          fi
          echo "Parsing publish profile for scm url and credentials..."
          echo "$KUDU_PUBLISH_PROFILE" > pubxml.xml
          SCM_URL=$(xmllint --xpath "string(//publishProfile[@publishMethod='MSDeploy']/@msdeployServiceUrl)" pubxml.xml 2>/dev/null || true)
          # fallback: look for publishProfile with publishMethod="MSDeploy" or "FTP"
          if [ -z "$SCM_URL" ]; then
            SCM_URL=$(xmllint --xpath "string(//publishProfile/@publishUrl)" pubxml.xml 2>/dev/null || true)
          fi
          PUSER=$(xmllint --xpath "string(//publishProfile/@userName)" pubxml.xml)
          PPASS=$(xmllint --xpath "string(//publishProfile/@userPWD)" pubxml.xml)
          if [ -z "$SCM_URL" ] || [ -z "$PUSER" ] || [ -z "$PPASS" ]; then
            echo "Could not parse publish profile. Skipping Kudu commands."
            exit 0
          fi
          echo "SCM URL: $SCM_URL"

          # Kudu API: /api/command to run commands
          echo "Running collectstatic via Kudu API..."
          curl -s -X POST -u "$PUSER:$PPASS" "$SCM_URL/api/command" -H "Content-Type: application/json" -d '{"command":"python manage.py collectstatic --noinput","dir":"/home/site/wwwroot"}' | jq -r
          echo "Running migrate via Kudu API..."
          curl -s -X POST -u "$PUSER:$PPASS" "$SCM_URL/api/command" -H "Content-Type: application/json" -d '{"command":"python manage.py migrate --noinput","dir":"/home/site/wwwroot"}' | jq -r

      - name: Restart Web App
        env:
          AZ_SUBSCRIPTION: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_E84FA381A384446FBED047D7993DFEB4 }}
          AZ_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
          AZ_WEBAPP_NAME: ${{ env.AZ_WEBAPP_NAME }}
        run: |
          az webapp restart --subscription "$AZ_SUBSCRIPTION" --resource-group "$AZ_RESOURCE_GROUP" --name "$AZ_WEBAPP_NAME"
