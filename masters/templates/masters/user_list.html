{% extends 'base.html' %}

{% block title %}Users | SmartHR ERP{% endblock %}

{% block page_title %}
<h2 class="fw-bold">Users</h2>
{% endblock %}

{% block content %}
<style>
  :root {
    --sidebar-bg: #2f3e46;
    --sidebar-color: #ffffff;
    --sidebar-hover: #124e51;
    --active-bg: #52796f;
    --accent-btn: #3caea3;
    --accent-btn-hover: #2f8886;
    --body-bg: #f8f9fa;
    --card-bg: #ffffff;
    --text-dark: #333333;
    --btn-danger:#d9534f; --btn-danger-hover:#c9302c;
  }

  body { background-color: var(--body-bg); color: var(--text-dark); font-family: 'Inter', sans-serif; }

  .leave-card { background: var(--card-bg); border-radius: 12px; padding: 1.5rem; box-shadow:0 4px 12px rgba(0,0,0,.08); }

  .btn-accent { background-color: var(--accent-btn)!important; color:#fff!important; border:none!important; border-radius:6px; transition:0.2s; }
  .btn-accent:hover { background-color: var(--accent-btn-hover)!important; }

  .btn-danger{background:var(--btn-danger)!important;color:#fff!important;border:none;border-radius:6px;}
  .btn-danger:hover{background:var(--btn-danger-hover)!important;}

  table.table th { background-color: #f1f3f5; font-weight: 600; }
  .table td { vertical-align: middle; }

  .action-icons a, .action-icons button { margin: 0 5px; font-size: 18px; }

  .alert { padding: 8px 12px; margin-bottom: 15px; border-radius: 4px; }
  .alert-error { background-color: #f8d7da; color: #124e51; }
  .alert-success { background-color: #d1e7dd; color: #0f5132; }

  /* Custom delete popup */
  .popup-overlay {
    display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:999;
  }
  .popup-content {
    background:#fff; padding:20px; border-radius:10px; max-width:400px; text-align:center;
    box-shadow:0 4px 12px rgba(0,0,0,.2);
  }
  .popup-buttons { display:flex; justify-content:center; gap:10px; margin-top:15px; }
</style>

<div class="container mt-4">
  <div class="leave-card">
    <div class="mb-3 text-start">
      <a href="{% url 'user_form' %}" class="btn btn-accent"><i class="bi bi-plus-circle"></i> Add User</a>
    </div>

    {% if error %}
      <div class="alert alert-error">{{ error }}</div>
    {% endif %}
    {% if success_message %}
      <div class="alert alert-success">{{ success_message }}</div>
    {% endif %}

    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>Username</th>
            <th>Password</th>
            <th>Wrong Attempts</th>
            <th>Locked</th>
            <th>Passcode</th>
            <th>Passcode Set</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
            <tr>
              <td>{{ user.username }}</td>
              <td>{{ user.password|slice:":10" }}...</td>
              <td>{{ user.wrong_attempts }}</td>
              <td>{{ user.is_locked|yesno:"Yes,No" }}</td>
              <td>{{ user.passcode|default:"None" }}</td>
              <td>{{ user.passcode_set|yesno:"Yes,No" }}</td>
              <td class="action-icons">
                <a href="{% url 'user_view' user.id %}" title="View" class="text-primary"><i class="bi bi-eye"></i></a>
                <a href="{% url 'user_edit' user.id %}" title="Edit" class="text-warning"><i class="bi bi-pencil"></i></a>
                <button type="button" class="btn btn-link text-danger p-0 deleteBtn" data-id="{{ user.id }}" data-username="{{ user.username }}">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="7" class="text-center">No users found.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Custom Delete Popup -->
<div class="popup-overlay" id="popupOverlay">
  <div class="popup-content">
    <p id="popupMessage">Are you sure you want to delete this user?</p>
    <div class="popup-buttons">
      <form id="deleteForm" method="post" style="margin:0;">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger">Yes, Delete</button>
        <button type="button" class="btn btn-secondary" id="cancelDelete">Cancel</button>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const overlay = document.getElementById('popupOverlay');
  const cancelBtn = document.getElementById('cancelDelete');
  const deleteForm = document.getElementById('deleteForm');
  const popupMessage = document.getElementById('popupMessage');

  document.querySelectorAll('.deleteBtn').forEach(btn => {
    btn.addEventListener('click', function(){
      const userId = this.dataset.id;
      const username = this.dataset.username;
      popupMessage.textContent = `Are you sure you want to delete ${username}?`;
      deleteForm.action = `/masters/users/${userId}/delete/`; // âœ… delete URL
      overlay.style.display = 'flex';
    });
  });

  cancelBtn.addEventListener('click', function(){
    overlay.style.display = 'none';
  });
});
</script>
{% endblock %}
